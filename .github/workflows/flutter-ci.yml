stages:
  - build
  - test
  - deploy

# Cache dependencies for faster build
cache:
  paths:
    - .pub-cache/

# Default image for running the jobs (Flutter Docker image)
image: cirrusci/flutter:stable

# Job to install dependencies and set up Flutter
install_dependencies:
  stage: build
  script:
    - flutter pub get  # Install Flutter dependencies
  only:
    - main
    - develop

# Job to analyze the code
analyze_code:
  stage: test
  script:
    - flutter analyze  # Run code analysis
  only:
    - main
    - develop

# Job to format the code
format_code:
  stage: test
  script:
    - flutter format --set-exit-if-changed .  # Format code
  only:
    - main
    - develop

# Job to run unit and widget tests
run_tests:
  stage: test
  script:
    - flutter test  # Run Flutter unit and widget tests
  only:
    - main
    - develop

# Job to check outdated dependencies
check_dependencies:
  stage: test
  script:
    - flutter pub outdated  # Check for outdated dependencies
  only:
    - main
    - develop

# Job to build the app for Android
build_android:
  stage: build
  script:
    - flutter build appbundle --release  # Build Android app bundle
  only:
    - main
    - develop

# Job to build the app for iOS
build_ios:
  stage: build
  script:
    - flutter build ios --release --no-codesign  # Build iOS app
  only:
    - main
    - develop

# Job to deploy the app for Android (Google Play)
deploy_android:
  stage: deploy
  script:
    - echo "Deploying Android app to Google Play..."
    # Add Fastlane or Google Play deployment script here
    # - fastlane android release
  only:
    - main

# Job to deploy the app for iOS (TestFlight or App Store)
deploy_ios:
  stage: deploy
  script:
    - echo "Deploying iOS app to TestFlight/App Store..."
    # Add Fastlane or App Store deployment script here
    # - fastlane ios beta  # For TestFlight deployment
    # - fastlane ios release  # For App Store deployment
  only:
    - main
